# API密钥安全指南

## 概述

加密货币合约计算器支持用户配置币安API密钥，以获取用户特定的手续费和杠杆限制。本文档详细说明了如何安全地管理和使用API密钥。

## 安全架构

### 1. 客户端加密存储

您的API密钥在客户端使用基于浏览器指纹的加密方式存储在 `localStorage` 中：

- **加密方式**：XOR加密 + Base64编码（用于混淆，防止casual inspection）
- **加密密钥**：基于浏览器信息生成（User Agent、语言、时区）
- **存储位置**：浏览器 localStorage（仅在您的设备上）
- **有效期**：永久存储，直到您手动删除

```javascript
// 加密流程
1. 获取浏览器指纹 → 生成加密密钥
2. 使用XOR加密您的API密钥
3. Base64编码加密结果
4. 存储到localStorage
```

### 2. 传输安全

当需要使用API密钥时：

```
1. 浏览器解密本地存储的API密钥
2. 通过HTTPS加密通道发送到服务器
3. 服务器使用密钥调用币安API
4. 服务器不存储您的API密钥
5. 响应数据返回给客户端
```

### 3. 后端安全处理

**关键原则**：
- ✅ 服务器接收API密钥后立即使用，不进行持久化存储
- ✅ API密钥仅在内存中存在
- ✅ 请求完成后立即清除敏感信息
- ✅ 所有操作通过HTTPS加密传输
- ✅ API调用使用HMAC-SHA256签名

```typescript
// 后端处理流程
1. 接收客户端发送的API密钥（通过HTTPS）
2. 验证密钥格式
3. 创建SecureApiKeyHandler实例
4. 使用密钥调用币安API
5. 清除内存中的敏感信息
6. 返回结果给客户端
```

## 使用指南

### 配置API密钥

1. **打开计算器**：访问合约计算器页面
2. **找到"币安API配置"卡片**：位于"多仓位对比分析"上方
3. **输入API密钥**：
   - API密钥：从币安账户复制
   - API Secret：从币安账户复制
4. **点击"保存密钥"**：加密存储到本地
5. **确认状态**：显示"已配置"表示成功

### 获取币安API密钥

#### 步骤1：登录币安账户
访问 [币安官网](https://www.binance.com) 并登录您的账户

#### 步骤2：进入API管理
1. 点击右上角账户图标
2. 选择 **API管理**
3. 点击 **创建API**

#### 步骤3：配置API密钥
1. **标签名称**：输入 "合约计算器" 或其他易识别的名称
2. **API权限**：选择以下权限
   - ✅ **现货及杠杆交易** - 必需
   - ❌ **提现** - 不需要
   - ❌ **转账** - 不需要
   - ❌ **其他敏感操作** - 不需要
3. **IP白名单**：强烈建议设置
   - 添加您常用的IP地址
   - 提高安全性

#### 步骤4：复制密钥
1. 复制 **API Key**
2. 复制 **Secret Key**
3. 在计算器中粘贴这两个值

### 删除API密钥

1. 打开 **币安API配置** 卡片
2. 点击 **删除** 按钮
3. 确认删除
4. 同时建议在币安账户中删除对应的API密钥

## 安全最佳实践

### ✅ 应该做的事

1. **定期轮换**：每3-6个月更换一次API密钥
2. **最小权限**：只授予必要的权限（现货及杠杆交易）
3. **IP白名单**：在币安设置IP白名单
4. **可信设备**：仅在您拥有和控制的设备上配置
5. **HTTPS连接**：确保使用HTTPS访问计算器
6. **监控账户**：定期检查币安账户的API调用日志
7. **及时删除**：不使用时删除API密钥

### ❌ 不应该做的事

1. **不要共享**：不要将API密钥分享给任何人
2. **不要硬编码**：不要在代码中硬编码API密钥
3. **不要截图**：不要截图或拍照保存API密钥
4. **不要使用公共WiFi**：避免在不安全的网络上配置
5. **不要授予提现权限**：即使看起来很方便也不要
6. **不要忽视警告**：如果看到异常活动立即删除密钥
7. **不要相信第三方**：不要在不信任的网站上输入API密钥

## 常见问题

### Q1: 我的API密钥安全吗？

**A:** 相对安全。我们采用了多层安全措施：
- 客户端加密存储
- HTTPS传输
- 服务器不持久化存储
- 及时清除内存

但没有绝对的安全。建议：
- 定期轮换密钥
- 使用IP白名单
- 监控账户活动

### Q2: 如果我的设备被黑客入侵怎么办？

**A:** 立即：
1. 登录币安账户
2. 删除所有API密钥
3. 更改币安账户密码
4. 启用二次验证

### Q3: 为什么需要API Secret？

**A:** API Secret用于签署请求。币安API要求：
- 所有需要认证的请求都必须签署
- 签署使用HMAC-SHA256算法
- Secret永远不会发送给币安，只用于本地签署

### Q4: 计算器会存储我的API密钥吗？

**A:** 不会。
- 客户端：加密存储在您的浏览器中
- 服务器：接收后立即使用，不存储
- 数据库：完全不涉及

### Q5: 如果我忘记删除API密钥怎么办？

**A:** 
1. 登录币安账户
2. 进入API管理
3. 删除对应的API密钥
4. 在计算器中也删除

### Q6: 可以在多个设备上使用同一个API密钥吗？

**A:** 可以，但不推荐。建议：
- 为每个设备创建不同的API密钥
- 这样可以单独控制和撤销每个密钥
- 提高安全性和可控性

### Q7: API密钥过期吗？

**A:** 不过期。但建议：
- 定期轮换（每3-6个月）
- 删除不使用的密钥
- 监控异常活动

## 数据流程图

```
┌─────────────────────────────────────────────────────────────┐
│                      您的浏览器                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  1. 输入API密钥和Secret                              │  │
│  │  2. 客户端加密（基于浏览器指纹）                      │  │
│  │  3. 存储到localStorage                               │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
                    需要使用API密钥时
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    HTTPS加密通道                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  4. 解密本地密钥                                      │  │
│  │  5. 通过HTTPS发送到服务器                             │  │
│  │  6. 服务器接收（HTTPS解密）                           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      服务器处理                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  7. 验证密钥格式                                      │  │
│  │  8. 使用密钥调用币安API（HMAC-SHA256签名）           │  │
│  │  9. 获取结果                                          │  │
│  │  10. 清除内存中的密钥                                 │  │
│  │  11. 返回结果给客户端                                 │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      您的浏览器                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  12. 接收结果（HTTPS解密）                            │  │
│  │  13. 显示手续费、杠杆信息等                           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 技术细节

### 客户端加密实现

```typescript
// 基于浏览器指纹生成加密密钥
function getLocalEncryptionKey(): string {
  const userAgent = navigator.userAgent;
  const language = navigator.language;
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const baseKey = `${userAgent}-${language}-${timezone}`;
  
  // 简单哈希函数
  let hash = 0;
  for (let i = 0; i < baseKey.length; i++) {
    const char = baseKey.charCodeAt(i);
    hash = (hash << 5) - hash + char;
    hash = hash & hash;
  }
  
  return Math.abs(hash).toString(36);
}

// XOR加密
function simpleEncrypt(text: string, key: string): string {
  let result = "";
  for (let i = 0; i < text.length; i++) {
    result += String.fromCharCode(
      text.charCodeAt(i) ^ key.charCodeAt(i % key.length)
    );
  }
  return btoa(result); // Base64编码
}
```

### 后端API签名

```typescript
// HMAC-SHA256签名
function generateSignature(
  queryString: string,
  apiSecret: string
): string {
  return createHmac("sha256", apiSecret)
    .update(queryString)
    .digest("hex");
}

// 创建带签名的请求
const timestamp = Date.now();
const queryString = `timestamp=${timestamp}`;
const signature = generateSignature(queryString, apiSecret);
const url = `${baseUrl}?${queryString}&signature=${signature}`;
```

## 支持和反馈

如果您对API密钥安全有任何疑问或建议，请：
1. 查看本文档的相关部分
2. 查看币安官方安全文档
3. 提交反馈或问题

## 更新日志

- **v1.0** (2025-10-30)：初始版本
  - 客户端加密存储
  - HTTPS传输
  - 服务器不持久化存储
  - 完整的安全指南

---

**最后更新**：2025-10-30

**责任声明**：虽然我们采取了多项安全措施，但没有绝对的安全保证。用户应自行承担使用API密钥的风险。定期轮换密钥、使用IP白名单、监控账户活动是保护您账户的最佳方式。

